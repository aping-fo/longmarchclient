{"version":3,"sources":["UIHelper.js"],"names":["WXTool","require","SetLastSiblingIndex","node","parent","lastIndex","i","children","length","Math","max","getSiblingIndex","setSiblingIndex","GetCaptureCamera","captureCameraNode","cc","find","Canvas","instance","Node","setParent","captureCamera","addComponent","Camera","cullingMask","active","name","position","Vec2","ZERO","getComponent","SetImageFromUrl","sprite","url","isRemote","spriteFrame","loader","load","err","tex","error","message","SpriteFrame","loadRes","SaveNodeRender","pageHeigth","isStore","callback","enable","oldPosition","oldActive","worldBoundingBox","getBoundingBoxToWorld","width","winSize","height","renderTexture","RenderTexture","initWithSize","targetTexture","canvas","wx","createCanvas","ctx","getContext","saveHeight","rowBytes","page","ceil","render","data","readPixels","x","beginRow","endRow","min","row","srow","imageData","createImageData","start","_i","putImageData","y","destroy","path","toTempFilePathSync","getInstance","saveFileToLocal","res","SaveCanvas","withoutNodes","visibleStatus","push","renderer","director","getScene","game","module","exports"],"mappings":"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","file":"UIHelper.js","sourceRoot":"..\\..\\..\\..\\..\\assets\\scripts\\tools","sourcesContent":["var WXTool = require(\"WXTool\");\r\n\r\nfunction SetLastSiblingIndex(node, parent){\r\n    if(parent == null){\r\n        parent = node.parent;\r\n    }\r\n\r\n    let lastIndex = 0;\r\n    for(var i = 0; i < parent.children.length; i++){\r\n        lastIndex = Math.max(lastIndex, parent.children[i].getSiblingIndex());\r\n    }\r\n\r\n    node.setSiblingIndex(lastIndex + 1);\r\n}\r\n\r\nfunction GetCaptureCamera() {\r\n    var captureCameraNode = cc.find(\"CaptureCamera\", cc.Canvas.instance.node);\r\n    if (captureCameraNode == null) {\r\n        var captureCameraNode = new cc.Node();\r\n        captureCameraNode.setParent(cc.Canvas.instance.node);\r\n        \r\n        var captureCamera = captureCameraNode.addComponent(cc.Camera);\r\n        captureCamera.cullingMask = 0x00000002;\r\n\r\n        captureCameraNode.active = false;\r\n        captureCameraNode.name = \"CaptureCamera\";\r\n        captureCameraNode.position = cc.Vec2.ZERO;\r\n    }\r\n    return captureCameraNode.getComponent(cc.Camera);\r\n}\r\n\r\nfunction SetImageFromUrl(sprite, url, isRemote) {\r\n    if (url == \"\") {\r\n        sprite.spriteFrame = null;\r\n        return;\r\n    }\r\n\r\n    if (isRemote == null) {\r\n        isRemote = false;\r\n    }\r\n\r\n    if (isRemote) {\r\n        url += \"?aaa=aa.jpg\";\r\n        // console.log(\"load image\" + url);\r\n        cc.loader.load(url, function (err, tex) {\r\n            if (err) {\r\n                cc.error(err.message || err);\r\n                return;\r\n            }\r\n            sprite.spriteFrame = new cc.SpriteFrame(tex);\r\n        });\r\n    } else {\r\n        cc.loader.loadRes(url, cc.SpriteFrame, function (err, spriteFrame) {\r\n            if (err) {\r\n                cc.error(err.message || err);\r\n                return;\r\n            }\r\n            sprite.spriteFrame = spriteFrame;\r\n        });\r\n    }\r\n}\r\n\r\n//保存节点的图片\r\nfunction SaveNodeRender(node, pageHeigth, isStore, callback) {\r\n    if(!WXTool.enable){\r\n        if(callback){\r\n            callback(\"\");\r\n        }\r\n        return;\r\n    }\r\n\r\n    var oldPosition = node.position;\r\n    var oldActive = node.active;\r\n    node.active = true;\r\n\r\n    var worldBoundingBox = node.getBoundingBoxToWorld();\r\n    // pageHeigth = Math.min(pageHeigth, worldBoundingBox.height);\r\n    \r\n    var captureCamera = GetCaptureCamera();\r\n\r\n    var width = cc.winSize.width;\r\n    var height = cc.winSize.height;\r\n\r\n    captureCamera.node.active = true;\r\n\r\n    //截屏renderTexture\r\n    var renderTexture = new cc.RenderTexture();\r\n    renderTexture.initWithSize(width, height);\r\n\r\n    captureCamera.targetTexture = renderTexture;\r\n\r\n    var canvas = wx.createCanvas();\r\n    var ctx = canvas.getContext(\"2d\");\r\n    var saveHeight = worldBoundingBox.height;\r\n    canvas.width = worldBoundingBox.width;\r\n    canvas.height = saveHeight;\r\n\r\n    var rowBytes = 4 * worldBoundingBox.width;\r\n    var page = Math.ceil(saveHeight / pageHeigth);  //如果比屏幕大，则多次截屏保存成1张\r\n    \r\n    for (var i = 0; i < page; i++) {\r\n        //渲染\r\n        captureCamera.render();\r\n\r\n        //读取数据\r\n        var data = renderTexture.readPixels(null, worldBoundingBox.x, 0, worldBoundingBox.width, pageHeigth);\r\n        var beginRow = i * pageHeigth;\r\n        var endRow = Math.min(beginRow + pageHeigth, saveHeight);\r\n\r\n        for (var row = beginRow; row < endRow; row++) {\r\n            var srow = endRow - 1 - row;\r\n            var imageData = ctx.createImageData(width, 1);\r\n            var start = srow * rowBytes;\r\n            for (var _i = 0; _i < rowBytes; _i++){\r\n                imageData.data[_i] = data[start + _i];\r\n            }\r\n            ctx.putImageData(imageData, 0, row);\r\n        }\r\n        node.position = new cc.Vec2(node.position.x, node.position.y + pageHeigth);\r\n        \r\n        renderTexture.destroy();\r\n        renderTexture = new cc.RenderTexture();\r\n        renderTexture.initWithSize(width, height);\r\n        captureCamera.targetTexture = renderTexture;\r\n    }\r\n    node.position = oldPosition;\r\n    node.active = oldActive;\r\n\r\n    captureCamera.node.active = false;\r\n    captureCamera.targetTexture = null;\r\n\r\n    renderTexture.destroy();\r\n\r\n\r\n    var path = canvas.toTempFilePathSync();\r\n    if(isStore){\r\n        WXTool.getInstance().saveFileToLocal(path, function(res, path){\r\n            if(res == \"success\"){        \r\n                if(callback){\r\n                    callback(path);\r\n                }\r\n            }\r\n        });\r\n    }else{\r\n        if(callback){\r\n            callback(path);\r\n        }\r\n    }\r\n}\r\n\r\n//保存画布\r\nfunction SaveCanvas(withoutNodes, isStore, callback){\r\n    if(!WXTool.enable){\r\n        if(callback){\r\n            callback(\"\");\r\n        }\r\n        return;\r\n    }\r\n\r\n    var visibleStatus = [];\r\n    for(var node of withoutNodes){\r\n        visibleStatus.push(node.active);\r\n        node.active = false;\r\n    }\r\n    \r\n    cc.renderer.render(cc.director.getScene());\r\n    var path = cc.game.canvas.toTempFilePathSync();\r\n    if(isStore){\r\n        WXTool.getInstance().saveFileToLocal(path, function(res, path){\r\n            if(res == \"success\"){        \r\n                if(callback){\r\n                    callback(path);\r\n                }\r\n            }\r\n            for(var i in withoutNodes){\r\n                withoutNodes[i].active = visibleStatus[i];\r\n            }\r\n        });\r\n    }else{\r\n        if(callback){\r\n            callback(path);\r\n        }\r\n        for(var i in withoutNodes){\r\n            withoutNodes[i].active = visibleStatus[i];\r\n        }\r\n    }\r\n}\r\n\r\nmodule.exports = {\r\n    SetLastSiblingIndex: SetLastSiblingIndex,\r\n    SetImageFromUrl: SetImageFromUrl,\r\n    SaveNodeRender: SaveNodeRender,\r\n    SaveCanvas: SaveCanvas,\r\n}"]}