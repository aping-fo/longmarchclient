{"version":3,"sources":["BeginPanel.js"],"names":["WXTool","require","GameManager","AudioManager","httpReq","Alert","cc","Class","extends","Component","properties","progressBar","type","ProgressBar","default","onLoad","init","director","on","onWXLoginSuccess","getInstance","lauchOption","getLaunchOptionsSync","console","log","wxOnShow","res","query","tips","roomId","familyId","length","show","loadScene","start","node","active","login","onDestroy","loader","onProgress","buttonTouchEnd","Button","prototype","_onTouchEnded","t","call","interactable","enabledInHierarchy","playEffect","EFFECT_TYPE","BUTTON","prepareResource","code","getCode","enable","openId","GetOpenId","resp","setOpenId","myInfo","wxName","getWxName","iconUrl","getAvatarUrl","UpdateRole","toString","PreLoadScene","LoadScene","CreateRole","_this","curCount","totalCount","item","progress"],"mappings":"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","file":"BeginPanel.js","sourceRoot":"..\\..\\..\\..\\assets\\scripts","sourcesContent":["/**\r\n * 启动面板\r\n * \r\n * 用户登录和授权面板\r\n */\r\nvar WXTool = require(\"WXTool\")\r\nvar GameManager = require(\"GameManager\");\r\nvar AudioManager = require(\"AudioManager\");\r\nvar httpReq=require('HttpReq');\r\nvar Alert=require(\"Alert\")\r\n\r\ncc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {\r\n\r\n        progressBar: {\r\n            type: cc.ProgressBar,\r\n            default: null\r\n        }\r\n    },\r\n\r\n    // LIFE-CYCLE CALLBACKS:\r\n\r\n    onLoad () {\r\n        this.init();\r\n\r\n        cc.director.on(\"WXLoginSuccess\", this.onWXLoginSuccess, this);\r\n        GameManager.getInstance().lauchOption= WXTool.getInstance().getLaunchOptionsSync();//启动参数\r\n        console.log(\"lauchOption:\", GameManager.getInstance().lauchOption) \r\n        WXTool.getInstance().wxOnShow(function(res){\r\n            GameManager.getInstance().lauchOption=res;\r\n            if(res != null && res.query!= null)\r\n            {\r\n                var tips='';\r\n                if(res.query.roomId != null)\r\n                {\r\n                    tips='是否接受邀请加入对战?';\r\n                }\r\n                else if(res.query.familyId != null)\r\n                {\r\n                    tips='是否接受邀请加入家庭群?';\r\n                }\r\n                if(tips.length>0)\r\n                {\r\n                    Alert.show(tips,function(){\r\n                        cc.director.loadScene(\"main\", function(){\r\n                        });\r\n                    },function(){\r\n                        GameManager.getInstance().lauchOption=null;\r\n                    },\"\",0.3)\r\n                }\r\n        \r\n            }\r\n        });\r\n    },\r\n\r\n    start () {\r\n        this.progressBar.node.active = false;\r\n        WXTool.getInstance().login();\r\n    },\r\n\r\n    onDestroy(){\r\n        cc.loader.onProgress = null;\r\n    },\r\n\r\n    init(){\r\n        //按钮添加音效\r\n        var buttonTouchEnd = cc.Button.prototype._onTouchEnded;\r\n        cc.Button.prototype._onTouchEnded = function(t){\r\n            buttonTouchEnd.call(this, t);\r\n            if(this.interactable && this.enabledInHierarchy){\r\n                AudioManager.getInstance().playEffect(AudioManager.EFFECT_TYPE.BUTTON);\r\n            }\r\n        }\r\n    },\r\n\r\n    // update (dt) {},\r\n    onWXLoginSuccess(){\r\n        console.log(\"wx login success\")\r\n        this.prepareResource();\r\n    },\r\n\r\n    prepareResource(){\r\n        this.progressBar.node.active = true;\r\n        var code=WXTool.getInstance().getCode()\r\n        if(!WXTool.enable)\r\n        {          \r\n            // httpReq.openId=parseInt(Math.random()*999);\r\n            httpReq.openId = \"123\";\r\n        }\r\n        GameManager.getInstance().GetOpenId(code,\r\n            function(resp)\r\n            {\r\n                var openId=resp['openId'];\r\n                WXTool.getInstance().setOpenId(openId);\r\n                httpReq.openId=openId;\r\n                GameManager.getInstance().myInfo = {\r\n                    wxName: WXTool.getInstance().getWxName(),\r\n                    iconUrl: WXTool.getInstance().getAvatarUrl(),\r\n                    openId: openId,\r\n                };\r\n\r\n                if(resp['hasRole'])\r\n                {\r\n                    GameManager.getInstance().UpdateRole(GameManager.getInstance().myInfo['wxName'],GameManager.getInstance().myInfo['iconUrl'],function(resp){\r\n                        if(resp.toString() == \"ok\")\r\n                        {\r\n                            GameManager.getInstance().PreLoadScene(\"game\");\r\n                            GameManager.getInstance().LoadScene(\"main\");\r\n                        }\r\n                    });\r\n                }\r\n                else\r\n                {\r\n                    GameManager.getInstance().CreateRole(GameManager.getInstance().myInfo['wxName'],GameManager.getInstance().myInfo['iconUrl'],function(resp){\r\n                        if(resp.toString() == \"ok\")\r\n                        {\r\n                            GameManager.getInstance().PreLoadScene(\"game\");\r\n                            GameManager.getInstance().LoadScene(\"main\");\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n        );\r\n\r\n        var _this = this;\r\n        cc.loader.onProgress = function(curCount, totalCount, item){\r\n            _this.progressBar.progress = curCount / totalCount;\r\n        };\r\n    }\r\n});\r\n"]}